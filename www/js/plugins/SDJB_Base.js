/* //====================================================================================================== //

            ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣀⣀⣀⣀⣀⣠⣼⠂⠀⠀⠀⠀⠙⣦⢀⠀⠀⠀⠀⠀⢶⣤⣀⣀⣀⣀⣀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
            ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣠⣴⣶⣿⣿⣿⣿⣿⣿⣿⣿⠷⢦⠀⣹⣶⣿⣦⣿⡘⣇⠀⠀⠀⢰⠾⣿⣿⣿⣟⣻⣿⣿⣿⣷⣦⣄⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
            ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣤⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⡟⠀⠀⠀⠀⢺⣿⣿⣿⣿⣿⣿⣿⣆⠀⠀⠀⠀⠀⠀⢹⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣦⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
            ⠀⠀⠀⠀⠀⠀⠀⠀⢀⣴⢟⣥⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⢻⣿⣿⡏⢹⣿⣿⣿⣿⠀⠀⠀⠀⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣮⣝⢷⣄⠀⠀⠀⠀⠀⠀⠀⠀
            ⠀⠀⠀⠀⠀⠀⠀⣴⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⢛⣿⣿⣿⡇⠀⠀⠀⠀⠛⣿⣿⣷⡀⠘⢿⣧⣻⡷⠀⠀⠀⠀⠀⠀⣿⣿⣿⣟⢿⣿⣿⣿⣿⣿⣿⣿⣿⣝⢧⡀⠀⠀⠀⠀⠀⠀
            ⠀⠀⠀⠀⠀⢠⣾⣿⠟⣡⣾⣿⣿⣧⣿⡿⣋⣴⣿⣿⣿⣿⣧⠀⠀⠀⠀⠀⢻⣿⣿⣿⣶⡄⠙⠛⠁⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣷⣝⢻⣿⣟⣿⣿⣷⣮⡙⢿⣽⣆⠀⠀⠀⠀⠀
   ░██████╗██╗░░██╗░█████╗░██████╗░░█████╗░░██╗░░░░░░░██╗██████╗░██████╗░░█████╗░░██████╗░░█████╗░███╗░░██╗
   ██╔════╝██║░░██║██╔══██╗██╔══██╗██╔══██╗░██║░░██╗░░██║██╔══██╗██╔══██╗██╔══██╗██╔════╝░██╔══██╗████╗░██║
   ╚█████╗░███████║███████║██║░░██║██║░░██║░╚██╗████╗██╔╝██║░░██║██████╔╝███████║██║░░██╗░██║░░██║██╔██╗██║
   ░╚═══██╗██╔══██║██╔══██║██║░░██║██║░░██║░░████╔═████║░██║░░██║██╔══██╗██╔══██║██║░░╚██╗██║░░██║██║╚████║
   ██████╔╝██║░░██║██║░░██║██████╔╝╚█████╔╝░░╚██╔╝░╚██╔╝░██████╔╝██║░░██║██║░░██║╚██████╔╝╚█████╔╝██║░╚███║
   ╚═════╝░╚═╝░░╚═╝╚═╝░░╚═╝╚═════╝░░╚════╝░░░░╚═╝░░░╚═╝░░╚═════╝░╚═╝░░╚═╝╚═╝░░╚═╝░╚═════╝░░╚════╝░╚═╝░░╚══╝
            ⣿⠃⢠⡿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣄⣤⣀⠀⠀⣿⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⢻⡇⠀⣿
            ⣿⠀⢸⠅⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣰⡿⠋⠉⢻⣧⢀⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠀⢸
            ⡇⠀⠈⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢿⣧⡀⠀⠀⣿⣾⡟⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠀⢸
            ⢸⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠻⠿⣿⣿⠟⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡾
            ⠈⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣰⡿⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠃
            ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢰⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
            ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣧⢀⣾⣤⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
            ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⡼⣿⣿⣾⣤⣠⡼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀

*/ //====================================================================================================== //
"use strict"


/** /*:
* 
* @author ShadowDragon
* @plugindesc Base plugin required for my Plugins.
*
* @help
*
* This is the BASE plugin that goes on top of all my plugins to use.
* As it has some fixes and ingame functionality to use which can be used
* are explained below.
*
* It's best to place this plugin above YEP_CoreEngine for max compability.
* There are features/patch described below that can be used inside the game,
* as well for helper function for my other plugin.
* 
* //============ 
*   PARAMETERS
* ============//
* Max Picture
* ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ 
* when setting "Max Picture" higher than 100, use the scriptcall as default
* to call the ID above 100, for "Battle" use PictureId + MaxPicture.
* if Max Picture = 2000, than Battle Picture start at 2001.
*
* $gameScreen.showPicture(pictureId, name, origin, x, y, scaleX, scaleY, opacity, blendMode)
* Example:
* $gameScreen.showPicture(1742, "File", 0, 10, 10, 100, 100, 255, 0)
*
* Other scriptcalls are required as normal:
*
* $gameScreen.movePicture(pictureId, origin, x, y, scaleX, scaleY, opacity, blendMode, duration);
* $gameScreen.rotatePicture(pictureId, speed);
* $gameScreen.tintPicture(pictureId, tone, duration);
* $gameScreen.erasePicture(pictureId);
*
*
* Enemy Plural names
* ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ 
* Remove the plural letters A, B, C, D, ...etc from the same enemies in battle,
* set it in the parameter to keep it or remove it.
*
*
* Max Item Limit
* ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ 
* Set how many items you can carry per item, weapon, armor (if they can stack).
* You can use JavaScript to control the item like: $gameVariables.value(12) to store
* the max Item Limit in there whatever the value may be.
*
*
* Debt System
* ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ 
* There are times you can buy stuff, but not enough gold, if you set it to ON,
* you can go under your currency.
*
* When that happens, you can decide what happens when they go under it.
* you can kick out group out of the store or pay back the gold they owned first
* before they can buy new stuff.
*
* When its OFF, it uses the default behavior.
*
*
* //================== 
*   FUNCTIONALITIES
* =================//
* RealTime (for variables or conditional check on users System)
* ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞
*
* getTime() function has some usefull time parts that can set in a variable
* or multiple variables to get the date you want to show.
*
* Samples you can use in a variable or a Real Time System (must be set manually).
* getTime() => returns default: "day" "fullMonth", "hour":"minutes" 
*
* getTime("string") can return the following if you them seperatly to read the systemTime.
* "hour" or "hr" => get the hours in string, number lower than 10 will convert it with a "0" in front
* "minutes" or "min" => get the minutes in string, number lower than 10 will convert it with a "0" in front
* "seconds" or "sec" => get the seconds in string, number lower than 10 will convert it with a "0" in front
* "day" => get you the day of the week (1, 2, 3, ...)
* "week" => get you the full Name of the week ("Sunday", "Monday", "Tuesday", ...)
* "month" => get the month Name fully ("January", "February", "March", ... etc)
* "monthN"  => get the month value, number lower than 10 will convert it with a "0" in front
* "year" => get the full year (2023)
* "curTime" => returns the time "16:50"
* "curDate" => returns "wednesday 29 march 2023"
*
*
* Conditional Brance Scriptcalls
* ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ 
* The Scriptcall below checks the EventID from Player Distance
* SDJB.DistanceEP(eventId, Distance)
*
* Example: 
* SDJB.DistanceEP(4, 10)
* This checks if EventId 4 is 10 tiles away from the player, if it does,
* execute a command or flip a switch (becareful with parallels)!
* I recommend a minimum of 30 frames in between or more.
*
* SDJB.DistanceEE(eventId1, eventId2, Distance)
*
* Example: 
* SDJB.DistanceEE(4, 7, 4)
* This checks if EventId 4 and EventId 7 are 10 tiles away from each other, 
* if it does, execute a command or flip a switch (becareful with parallels)!
* I recommend a minimum of 30 frames in between or more.
*
*
* Scriptcalls Lock and Unlock events and/or player
* ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ 
* SDJB.lock();  <= This will lock both events and player movement
* SDJB.unlock(); <= This will unlock both events and player movement
* SDJB.lockEvents(); <= This will lock all events
* SDJB.unlockEvents(); <= This will unlock all events
* SDJB.lockPlayer(); <= This will lock the player
* SDJB.unlockPlayer(); <= This will lock the player
*
* 
* Battle Scriptcall for Troop pages
* ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ 
* Sometimes, you want to change battle mid battle, or its sounds.
* sounds works, but the battlebacks doesn't always change without
* updating it first, so we need to force it. 
*
* use the following scriptcall in the troop event page:
* 
* changeBattleBG(battleback1, battleback2)
*
* example: changeBattleBG("Lava1", "Lava")
* //============================
*   IMPROVED FUNCTIONS / FIXES
* ============================//
*
* Disable F5 
* ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ 
* F5 button can be disabled (default: false).
* When Disabled: the game won't reboot.
* When Enabled: the game will reboot as normal.
*
* NOTE: this does NOT work online because the refresh button still works.
*
*
* Fix PlayTime, FrameCount, Bitmap Pixels 
* ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞
* Fix PlayTime to be accurate and FrameCount to avoid Game Freezes
* as well for pixels on bitmap images.
*
*
* Window_Selectable
* ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ 
* Fix scrolling function (move cursor down, left, right, up)
* Improve selection in window, what is last, return to the first, up and down last item on the bottom.
* this is not default as it stops on the last index and wont scroll/jump back to the top, so this is
* implemented to make it work like that for smoother navigations.
*
*
* Window_NameEdit
* ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ 
* Fix letters on the Name Input window that aren't centered by default.
* This fix it as manu forget to do this when name input is used.
*
*
* Custom Escape Characters & Process Escape Characters
* ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ 
* \MAP[n] will show you MapId's Names (not the Display Name). (no more typo's in Map Names).
*
* \WAIT[n] will wait x frames, this gives you a bit more control when the text continues.
*
* More might come or with idea's to add them.
*
*
* Play all Common Events
* ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ 
* Play all Common Events in a row that is set, otherwise, only the last one will play.
* This will remove a common event in the queue and play the next one.
*
*
* Game_Character Fix MoveRoute
* ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ ͞ 
* Fix the MoveRoute from events than start over from a move route when you interacted with it.
*
*
* === TERMS OF USE ===
* Free for Non-Commercial and Commercial use when credit is given.
* credit one of the following:
* ShadowDragon 
* ShadowDragonJB
*
* Version + UPDATE'S
* dd-mm-2024 Version 0.1.0 first release
*
* === WARNING ===
*
* YOU ARE NOT ALLOWED TO:
* * MODIFY without permission 
* * EXTEND without permission
* * TAKE CODE without permission
* * CLAIM AS YOU MADE IT 
* * REDISTRIBUTE but link back to the forum or itch.io
* * SELL this product as standalone.
* * DO NOT REMOVE THE HEADER.
*
*
* @param <= System =>
* @param <= Game System =>
* @param <= Screen =>
* @param <= Windows =>
* @param <= Main Player =>
* @param <= Party Group =>
* @param <= Enemies =>
*
* @param Disable F5
* @parent <= System =>
* @type boolean
* @on Disable F5
* @off Enable F5
* @desc Enable or Disable F5 button. When Disabled,
* F5 cannot be used.
* @default false
*
* @param AfterLoad CE
* @parent <= Game System =>
* @desc set ID that runs after you load a save file
* set 0 for not using.
* @default 0
* 
* @param Max Pictures
* @parent <= Screen =>
* @type number
* @desc set amount of max Pictures
* @default 100
*
* @param Name Input Window
* @parent <= Windows =>
* @type boolean
* @on Yes
* @off No
* @desc Fix Name Input Window?
* @default true
*
* @param Item Limit
* @parent <= Party Group =>
* @desc set Item Limit globally, can use JavaScript.
* Use <Item Limit: n> in "item note" (fixed or JavaScript).
* @default 9
*
* @param Debt System
* @parent <= Party Group =>
* @type boolean
* @on Use Debt System
* @off No Debt System
* @desc Do you want to use a debt system?
* @default false
*
* @param Max Debt
* @parent <= Party Group =>
* @type number
* @min -9999999999999999999999
* @max 0
* @desc set the max debt they can go under the currency
* @default -250000
*
* @param Enemy Original names
* @parent <= Enemies =>
* @type boolean
* @on Remove plural
* @off Keep plural
* @desc when ON: Remove plural behind enemies names
* when OFF: Enemies show A, B, C behind its name,
* @default true
*/

/**
 * @Imported Import plugins list
 */
 var Imported = Imported || {};
     Imported["SDJB_Base"] = "1.0.0";

/**
 * @SDJB Shortcut for ShadowDragonJB
 */
    var SDJB = SDJB || {}; // functions, helpers
    var SDJB_Base = SDJB_Base || {}; // alias
    var SDJB_Helper = SDJB_Helper || {} // helpers

    SDJB._lockEvents = false;
    SDJB._lockPlayer = false;

/**
 * @SDJBParam Base parameter settings
 */
    const baseParams = SDJB_Check(PluginManager.parameters("SDJB_Base"));

    /**
     * @function debugs handles console more fancier
     */
     // RENEW FUNCTION
 
/**
 * Convert a JSON string or an object/array with JSON elements
 *
 * @param {any} element     The element to be converted
 * @return {any} 			Returns the converted element.
 */ 
   
    function SDJB_Check(element) {
        //=> Case 1: string
        if (typeof element === "string") {
            let parsedString;
            try {
                parsedString = JSON.parse(element);
            } catch {
                return element;
            }
            if (typeof parsedString === "object" || Array.isArray(parsedString)) {
                parsedString = SDJB_Check(parsedString);
            }
            return SDJB_Check(parsedString);
        }
        //=> Case 2: object
        else if (typeof element === "object" && !Array.isArray(element)) {
            let object = element;
            for (let key in object) {
                element[key] = SDJB_Check(element[key]);
            }
            return object;
        }
        //=> Case 3: array
        else if (typeof element === "object" && Array.isArray(element)) {
            element.forEach((entry, index) => {
                element[index] = SDJB_Check(entry);
            })
            return element;
        } else {
            return element;
        }
    };

    /**
     * @param {number} start starting number
     * @param {number} end ending number
     * @return retuns array with range of numbers start to end
    */
    function getRange(start, end) {
        return [...Array(end - start + 1).keys()].map(nr => nr + start);
    };

    /**
     * @param systemTime return switch function with a specific value
     * @return returns the value of the systemTime
    */
    function getTime(systemTime) {
        let day = new Date(), time;
        let hour = String(day.getHours()).padStart(2, "0");
        let minutes = String(day.getMinutes()).padStart(2, "0");
        let seconds = String(day.getSeconds()).padStart(2, "0");
        let week = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        let dayNum = String(day.getDay());
        let months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        let monthN = String(day.getMonth()).padStart(2, "0");
        let month = months[day.getMonth()];
        let year = String(day.getFullYear());
        switch(systemTime) {
            case "hour": case "hr":
                time = `${hour}`
                break;
            case "minutes": case "min":
                time = `${minutes}`
                break;
            case "seconds": case "sec":
                time = `${seconds}`
                break;
            case "day":
                time = `${dayNum}`
                break;
            case "week":
                time = `${week}`
                break;
            case "month":
                time = `${month}`
                break;
            case "monthN":
                time = `${month}`
                break;
            case "year":
                time = `${year}`
                break;
            case "curTime":
                time = `${hour}:${minutes}`
                break;
            case "curDate":
                time = `${week} ${dayNum} ${monthN} ${year}`
                break;
            default:
                time = `${dayNum} ${month}, ${hour}:${minutes}`
                break;
        }
        return time;
      };

    /**
     * @lock lock both event and player movements
    */
    SDJB.lock = function(){
        this._lockPlayer = true;
        this._lockEvents = true;
    };
    /**
     * @unlock unlock both event and player movements
    */
    SDJB.unlock = function(){
        this._lockPlayer = false;
        this._lockEvents = false;
    };
    /**
     * @lockEvents lock events movements
    */
    SDJB.lockEvents = function(){
        this._lockEvents = true;
    };
    /**
     * @unlockEvents unlock events movements
    */
    SDJB.unlockEvents = function(){
        this._lockEvents = false;
    };
    /**
     * @lockPlayer lock player movements
    */
    SDJB.lockPlayer = function(){
        this._lockPlayer = true;
    };
    /**
     * @unlockPlayer unlock player movements
    */
    SDJB.unlockPlayer = function(){
        this._lockPlayer = false;
    };


    SDJB_Base._GS_onAfterLoad = Game_System.prototype.onAfterLoad;
        Game_System.prototype.onAfterLoad = function() {
            SDJB_Base._GS_onAfterLoad.call(this);
                let CEId = baseParams["AfterLoad CE"];
                if (CEId > 0) $gameTemp.reserveCommonEvent(CEId);
        };

    
    //=> Stop movement for player
    SDJB_Base._GP_canMove = Game_Player.prototype.canMove;
        Game_Player.prototype.canMove = function() {
            if (SDJB._lockPlayer) return false;
            return SDJB_Base._GP_canMove.call(this);
        };
    
    //Stop movement for events
    SDJB_Base._GE_updateSelfMovement = Game_Event.prototype.updateSelfMovement;
        Game_Event.prototype.updateSelfMovement = function() {
            if (SDJB._lockEvents || this._moveType === 0) return;
            SDJB_Base._GE_updateSelfMovement.call(this);
        };

        

    //DistanceEP(4, 3) // Distance between eventId and Player (eventId 4 is 3 tiles away from Player)
    SDJB.DistanceEP = function(eventId, distance) {
        let gMe = $gameMap.event(eventId);
        let gPl = $gamePlayer;
        let pDist = distance;
        return gMe._x > gPl._x - pDist && gMe._x < gPl._x + pDist && gMe._y > gPl._y - pDist && gMe._y < gPl._y + pDist;
    };

    //DistanceEE(4, 8, 7) // Distance between 2 events (EventId 4 and EventId 8 are 7 tiles away from each other)
    SDJB.DistanceEE = function(eventId1, eventId2, distance) {
        let gMe1 = $gameMap.event(eventId1);
        let gMe2 = $gameMap.event(eventId2);
        let eDist = distance;
        return gMe1._x > gMe2._x - eDist && gMe1._x < gMe2._x + eDist && gMe1._y > gMe2._y - eDist && gMe1._y < gMe2._y + eDist;
    };

//===============
// Help Functions    
//===============
    /**
     * @method Array.prototype.remove Add remove to property to the array
     * @param {any} element removed from index
     */
    Object.defineProperty(Array.prototype, "remove", {
        value: function(element) { 
            const index = this.indexOf(element);
            if (index != -1) {
              this.splice(index, 1);
            };
         }
    });
    

//=============================
// Fixes, patches, improvements
// ============================
    ImageManager.loadBitmap = function(folder, filename, hue, smooth) { 
        if (filename) { 
            var path = folder + encodeURIComponent(filename) + ".png"; 
            var bitmap = this.loadNormalBitmap(path, hue || 0);    
                bitmap.smooth = false; 
            return bitmap; 
        } else { 
            return this.loadEmptyBitmap(); 
        }
    };

    SDJB_Base.preloadFolders = function() {
        // A list of preloaded images used by my plugins and others
        if (Imported["SDJB_TitleRewardIcons"]) {
            ImageManager.loadTRI = function(filename, hue) {
                return this.loadBitmap("img/shadowdragon/tri/", filename, hue, true);
            }
        };
        // better way for customize in the parameter struct
    };

    SDJB_Base._SB_start = Scene_Boot.prototype.start;
        Scene_Boot.prototype.start = function() {
            SDJB_Base.preloadFolders();
            SDJB_Base._SB_start.apply(this, arguments);
                
        };

    if (baseParams["Disable F5"]) {
        SDJB_Base._SM_onKeyDown = SceneManager.onKeyDown;
            SceneManager.onKeyDown = function(event) {
                if (event.code !== "F5") SDJB_Base._SM_onKeyDown.call(this, event);
            }
    };

    //=> PlayTime Fix + FrameCount Fix
    SDJB_Base._Graphic_render = Graphics.render;
        Graphics.render = function (stage) {
            if (this._skipCount < 0) {
                this._skipCount = 0;
            }
            SDJB_Base._Graphic_render.call(this, stage);
                this.frameCount--;
        };

    SDJB_Base._SM_updateScene = SceneManager.updateScene;
        SceneManager.updateScene = function() {
            SDJB_Base._SM_updateScene.call(this, arguments);
                Graphics.frameCount++;
        };

    //=============================
    // Battle Manager
    // ============================
    function changeBattleBG(battleback1, battleback2) {
        const spriteset = SceneManager._scene._spriteset;
        spriteset._back1Sprite.bitmap = ImageManager.loadBattleback1(battleback1);
        spriteset._back2Sprite.bitmap = ImageManager.loadBattleback2(battleback2);
    };

    //=> Window Selectable cursor movement
    Window_Selectable.prototype.updateCursorPos = function() {
        const rect = this.itemRect(this._index);
        this.setCursorRect(rect.x, rect.y, rect.width, rect.height);
        this.ensureCursorVisible();
    };
    
    Window_Selectable.prototype.cursorDown = function(wrap) {
        const index = this.index();
        const maxItems = this.maxItems();
        const maxCols = this.maxCols();
        if (index < maxItems - maxCols || (wrap && maxCols === 1)) {
            this.select((index + maxCols) % maxItems);
        } else {
            this._index -= (this.maxRows() * maxCols) - maxCols;
            if (this._index < 0) {
                this._index = maxItems - 1;
            } else if (this.maxRows() === 1) {
                return index;
            }
            this.updateCursorPos();
        }
    };
    
    Window_Selectable.prototype.cursorUp = function(wrap) {
        const index = Math.max(0, this.index());
        const maxItems = this.maxItems();
        const maxCols = this.maxCols();
        if (index >= maxCols || (wrap && maxCols === 1)) {
            this.select((index - maxCols + maxItems) % maxItems);
        } else {
            this._index += (this.maxRows() * maxCols) - maxCols;
            if (this._index >= maxItems) {
                this._index = maxItems - 1;
            } else if (this.maxRows() === 1) {
                return index;
            }
            this.updateCursorPos();
        }
    };

    Window_Selectable.prototype.cursorRight = function(wrap) {
        const index = this.index();
        const maxItems = this.maxItems();
        const maxCols = this.maxCols();
        const horizontal = this.isHorizontal();
        if (maxCols >= 2 && (index < maxItems - 1 || (wrap && horizontal))) {
            this.select((index + 1) % maxItems);
        } else if (maxCols > 1) {
            this.select(0);
        }
    };
    
    Window_Selectable.prototype.cursorLeft = function(wrap) {
        const index = Math.max(0, this.index());
        const maxItems = this.maxItems();
        const maxCols = this.maxCols();
        const horizontal = this.isHorizontal();
        if (maxCols >= 2 && (index > 0 || (wrap && horizontal))) {
            this.select((index - 1 + maxItems) % maxItems);
        } else if (maxCols > 1) {
            this.select(maxItems - 1);
        }
    };

    //=< Custom Escape Characters.
    SDJB_Base._WB_convertEscapeCharacters = Window_Base.prototype.convertEscapeCharacters;
        Window_Base.prototype.convertEscapeCharacters = function(text) {    
            text = SDJB_Base._WB_convertEscapeCharacters.call(this, text);
            if (Imported["SDJB_CMW"]) {
                text = this.convertEscapeCharactersCMW(text);
            }
            text = this.convertEscapeCharactersCustom(text);
            return text;
        };

    if (Imported["SDJB_CMW"]) {    
        Window_Base.prototype.convertEscapeCharactersCMW = function(text) {
            text = text.replace(/\x1bTT\[(\d+)\]/gi, function() { // Target Textbox
                $gameMessage._target = true;
                $gameMessage._targetId = arguments[1];
                return "";
            }.bind(this));
            text = text.replace(/\x1bCN\[(.*?)\]/gi, function() { // Current Name
                $gameMessage._textbox = true;
                $gameMessage._textboxName = arguments[1];
                return "";
            });
         return text;
        };
    }; // End Imported SDJB_CMW

    Window_Base.prototype.convertEscapeCharactersCustom = function(text) {
        // \MAP[n]
        text = text.replace(/\x1bMAP\[(\d+)\]/gi, function() {
            let hide = new RegExp(`<<(.*?)>>`);
            return $dataMapInfos[parseInt(arguments[1])].name.replace(hide, "");
        }.bind(this));
        // \???[n]


        // finally return
        return text;
    };

    SDJB_Base._WB_processEscapeCharacter = Window_Base.prototype.processEscapeCharacter;
        Window_Base.prototype.processEscapeCharacter = function(code, textState) {
            switch (code) {
                // \WAIT[n]
                case "WAIT":
                    var delay = this.obtainEscapeParam(textState);
                    this.startWait(delay);
                    break;
                case "???":
                    // new function
                    break;
                default:
                    SDJB_Base._WB_processEscapeCharacter.call(this, code, textState);
                    break;
            }
        };

    //=> Fix Name Input Font Display 
    if (baseParams["Name Input Window"]) {
        Window_NameEdit.prototype.drawChar = function(index) {
            var rect = this.itemRect(index);
            this.resetTextColor();
            this.drawText(this._name[index] || '', rect.x, rect.y, rect.width, 'center');
        };
    }

    //=> Play all Common Events
    SDJB_Base._GT_initialize = Game_Temp.prototype.initialize;
        Game_Temp.prototype.initialize = function() {
            SDJB_Base._GT_initialize.call(this);
                this._commonEventQueue = [];
        };
    
    Game_Temp.prototype.reserveCommonEvent = function(commonEventId) {
        if (commonEventId > 0) {
            this._commonEventQueue.push(commonEventId);
        }
    };
    
    Game_Temp.prototype.isCommonEventReserved = function() {
        return this._commonEventQueue.length > 0;
    };
    
    Game_Temp.prototype.reservedCommonEvent = function() {
        return $dataCommonEvents[this._commonEventQueue.shift()];
    };

    //=> GameScreen to change max Pictures
    Game_Screen.prototype.maxPictures = function() {
        return baseParams["Max Pictures"];
    };

    //=> Game_Party Max Items to carry
    Game_Party.prototype.maxItems = function(item) {
        if (!item) return 0;
        if (item.meta["Item Limit"]) { 
            return eval(item.meta["Item Limit"]); // <Item Limit: 5> or <Item Limit: valid JS Code>
        } else {                                  // Example <Item Limit: $gameVariables.value(x)>  x = variable ID
            return eval(baseParams["Item Limit"]);
        }
    };

    //=> Game_Party gold (change behavior)
    Game_Party.prototype.gainGold = function(amount) {
        if (baseParams["Debt System"]) {
            this._gold = (this._gold + amount).clamp(this.debtGold(), this.maxGold());
        } else {
            this._gold = (this._gold + amount).clamp(0, this.maxGold());
        }
    };

    Game_Party.prototype.debtGold = function() {
        return baseParams["Max Debt"];
    };


    //=> Game_Enemy to remove Plural letters
    Game_Enemy.prototype.name = function() {
        if (baseParams["Enemy Original names"]) {
            // when true, remove A,B,C,D,...etc
            return this.originalName();
        } else {
            return this.originalName() + (this._plural ? this._letter : '');
        }
    };

    //=> Game Character MoveRoute Fix
	SDJB_Base._GC_restoreMoveRoute = Game_Character.prototype.restoreMoveRoute;
        Game_Character.prototype.restoreMoveRoute = function() {
            SDJB_Base._GC_restoreMoveRoute.call(this);
                this._moveRouteIndex--;
        };
